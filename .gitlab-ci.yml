image: docker:git
services:
- docker:dind

stages:
- staging
- production
- build_image

variables:
<<<<<<< HEAD
  BASEURL: https://iflowfor8hours.info/
  HUGO_BINARY: hugo_0.17_Linux-64bit
  HUGO_VERSION:	0.17
  CONTAINER_RELEASE_IMAGE: registry.gitlab.com/iflowfor8hours/iflowfor8hours.info/image

before_script:
  - wget https://github.com/spf13/hugo/releases/download/v${HUGO_VERSION}/${HUGO_BINARY}.tar.gz
  - tar xzf ${HUGO_BINARY}.tar.gz -C ~/bin/
=======
  BASEURL: https://iflowfor9hours.info/
  CONTAINER_RELEASE_IMAGE: registry.gitlab.com/iflowfor8hours/iflowfor8hours.info/blog

before_script:
  - wget https://github.com/spf13/hugo/releases/download/v0.17/hugo_0.17_Linux-64bit.tar.gz
  - tar xzf hugo_0.17_Linux-64bit.tar.gz -C ~/bin/
>>>>>>> rename gitlab again
  - npm install --global surge

staging:
  stage: staging
  script:
  - ~/bin/hugo_0.17_linux_amd64/hugo_0.17_linux_amd64 -b https://staging.iflowfor8hours.info -d staging
  - surge staging --domain staging.iflowfor8hours.info
  - curl -s -k staging.iflowfor8hours.info| grep matt@iflowfor8hours.info || echo "SOMETHING WENT WRONG"

production:
  stage: production
  script:
  - ~/bin/hugo_0.17_linux_amd64/hugo_0.17_linux_amd64 -b https://iflowfor8hours.info
  - rsync --delete -ravz -e "ssh" ~/clone/public/ www-data@prod.iflowfor8hours.info:/var/www/iflowfor8hours.info
  only:
  - master

build_image:
  stage: build_image
  script:
    - docker login -u iflowfor8hours -p $CI_BUILD_TOKEN registry.gitlab.com
    - docker build --pull -t $CONTAINER_RELEASE_IMAGE .
    - docker push $CONTAINER_RELEASE_IMAGE
